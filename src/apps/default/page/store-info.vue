<template>
  <div>
    <group class="l-store-info">
      <div class="l-flex-h l-thumb">
        <img :src="$image.thumb(info.thumbnail, 80, 80)">
        <div class="l-rest">
          <span class="l-fr l-fgray"><i class="iconfont">&#xe634;</i>{{info.distance}}km</span>
          <h3 v-text="info.storeName"></h3>
        </div>
      </div>
      <cell :title="'营业时间 ' + info.openTime">
        <i class="iconfont" slot="icon">&#xe61f;</i>
      </cell>
      <cell :title="'订货电话 ' + info.workPhone">
        <i class="iconfont" slot="icon">&#xe612;</i>
      </cell>
      <cell :title="'门店地址 ' + info.address" :is-link='true' @click="openMap(info)">
        <i class="iconfont" slot="icon">&#xe600;</i>
      </cell>
    </group>

    <div v-if="info.introduce || storeImgList.length > 0" class="l-margin-tb l-store-details">
      <div v-html="info.introduce"></div>
      <div v-for="(index,item) in storeImgList" @click="$refs.previewer.show(index)">
        <img class="previewer-img" :src="item.src"/>  
      </div>
    </div>
    <previewer :list="storeImgList" v-ref:previewer :options="options"></previewer>
  </div>
</template>
<script>
import { Group, Cell, Previewer, Dialog } from 'vux-components'
import { utils, storage } from 'assets/lib'
import config from '../config'
import server from '../server'
import wx from 'weixin-js-sdk'

export default {
  components: {
    Group, Cell, Previewer, Dialog
  },
  route: {
    data(transition) {
      const self = this
      let promise1 = self.$http.get('owner/visitor/getStoreDetail', {
        params: {
          storeId: transition.to.query.id
        }
      })

      promise1.then(({ body })=>{
        if(body.success){
          self.info = body.data
          if(self.info.storeImgList){
            self.storeImgList = self.info.storeImgList.map((item) => {
              return {
                w: 640,
                h: 400,
                src: self.$image.thumb(item, 640, 400)
              }
            })
          }
        }
      })

      let promise2 = server.getPosition()

      // jssdk授权
      let promise3 = server.getWxConfig(window.location.href, ( config )=>{
        wx.config(config)
        wx.ready(()=>{
          self.wxReay = true
        })
        wx.error((res)=>{
          self.wxReay = false
        })
      })

      self.$vux.loading.show()
      Promise.all([promise1, promise2, promise3]).finally(()=>{
        let lng = storage.local.get('lng')
        let lat = storage.local.get('lat')

        self.info.distance = server.getDistance({
            lng1: lng, 
            lat1: lat
          }, {
            lng2: self.info.longitude,
            lat2: self.info.latitude
          })
        self.$vux.loading.hide()
      })
    }
  },
  data() {
    return {
      info: {},
      storeImgList: [],
      options: {
        getThumbBoundsFn (index) {
          // find thumbnail element
          let thumbnail = document.querySelectorAll('.previewer-img')[index]
          // get window scroll Y
          let pageYScroll = window.pageYOffset || document.documentElement.scrollTop
          // optionally get horizontal scroll
          // get position of element relative to viewport
          let rect = thumbnail.getBoundingClientRect()
          // w = width
          return {x: rect.left, y: rect.top + pageYScroll, w: rect.width}
          // Good guide on how to get element coordinates:
          // http://javascript.info/tutorial/coordinates
        }
      }
    }
  },
  methods: {
    openMap(storeEntity) {
      wx.openLocation({
        latitude: storeEntity.latitude,  
        longitude: storeEntity.longitude, 
        name: storeEntity.storeName,
        address: storeEntity.address, 
        scale: 15, // 地图缩放级别,整形值,范围从1~28。默认为最大
        infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
      })
    }
  }
}
</script>
<style type="text/css">
.l-store-info .weui_cells{
  margin-top: 0;
}
</style>
<style scoped lang="less">
.l-store-info {
  [slot=icon]{
    color: #4083c7;
    display: block;
    width: 30px;
    margin-top: -2px;
  }
  .l-thumb{
    padding: 0.4rem;
    h3{
      font-weight: 400;
    }
    img{
      width: 2.133333rem;
      height: 2.133333rem;
      margin-right: 0.266667rem;
    }
  }
}

.l-store-details{
  background-color: #fff;
  padding: 0.4rem;
  img{
    display: block;
    margin: 0.266667rem auto;
  }
}
</style>
